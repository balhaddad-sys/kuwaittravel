rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper Functions ──────────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() in ['admin', 'super_admin'];
    }

    function isCampaignOwner(campaignId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/campaigns/$(campaignId)).data.ownerId == request.auth.uid;
    }

    function isCampaignStaff(campaignId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/campaigns/$(campaignId)/staff/$(request.auth.uid));
    }

    function hasCampaignAccess(campaignId) {
      return isCampaignOwner(campaignId) || isCampaignStaff(campaignId) || isAdmin();
    }

    // Allowed roles for self-registration (no admin/super_admin)
    function isSafeRole(role) {
      return role in ['traveler', 'campaign_owner', 'campaign_staff'];
    }

    // ── Users ─────────────────────────────────────────────────────────
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();

      // Users can only self-assign safe roles (not admin/super_admin)
      allow create: if isOwner(userId)
        && request.resource.data.uid == request.auth.uid
        && isSafeRole(request.resource.data.role);

      // Owner can update own profile but cannot escalate to admin/super_admin
      // Admins can update any user including role changes
      allow update: if isAdmin()
        || (isOwner(userId)
            && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role'])
                || isSafeRole(request.resource.data.role)));

      allow delete: if isAdmin();
    }

    // ── Campaigns ─────────────────────────────────────────────────────
    match /campaigns/{campaignId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isCampaignOwner(campaignId) || isAdmin();
      allow delete: if isAdmin();

      // Campaign Staff subcollection
      match /staff/{staffId} {
        allow read: if hasCampaignAccess(campaignId);
        allow write: if isCampaignOwner(campaignId) || isAdmin();
      }
    }

    // ── Trips ─────────────────────────────────────────────────────────
    match /trips/{tripId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        hasCampaignAccess(request.resource.data.campaignId);
      allow update: if hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow delete: if isAdmin();

      match /itinerary_blocks/{blockId} {
        allow read: if isAuthenticated();
        allow write: if hasCampaignAccess(
          get(/databases/$(database)/documents/trips/$(tripId)).data.campaignId
        ) || isAdmin();
      }

      match /inventory/{itemId} {
        allow read: if isAuthenticated();
        allow write: if hasCampaignAccess(
          get(/databases/$(database)/documents/trips/$(tripId)).data.campaignId
        ) || isAdmin();
      }

      match /pricing_tiers/{tierId} {
        allow read: if isAuthenticated();
        allow write: if hasCampaignAccess(
          get(/databases/$(database)/documents/trips/$(tripId)).data.campaignId
        ) || isAdmin();
      }
    }

    // ── Bookings ──────────────────────────────────────────────────────
    match /bookings/{bookingId} {
      allow read: if isOwner(resource.data.travelerId) ||
        hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow create: if isAuthenticated() &&
        request.resource.data.travelerId == request.auth.uid;
      allow update: if isOwner(resource.data.travelerId) ||
        hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow delete: if isAdmin();

      match /passengers/{passengerId} {
        allow read: if isOwner(
          get(/databases/$(database)/documents/bookings/$(bookingId)).data.travelerId
        ) || hasCampaignAccess(
          get(/databases/$(database)/documents/bookings/$(bookingId)).data.campaignId
        ) || isAdmin();
        allow write: if isOwner(
          get(/databases/$(database)/documents/bookings/$(bookingId)).data.travelerId
        ) || hasCampaignAccess(
          get(/databases/$(database)/documents/bookings/$(bookingId)).data.campaignId
        ) || isAdmin();
      }
    }

    // ── Payments (server-write only) ──────────────────────────────────
    match /payments/{paymentId} {
      allow read: if isOwner(resource.data.payerId) ||
        hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow write: if false;
    }

    // ── Payouts (admin-managed) ───────────────────────────────────────
    match /payouts/{payoutId} {
      allow read: if hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow write: if isAdmin();
    }

    // ── Notifications ─────────────────────────────────────────────────
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.recipientId) || isAdmin();
      allow create: if hasCampaignAccess(request.resource.data.campaignId) || isAdmin();
      allow update: if isOwner(resource.data.recipientId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ── SOS Events ────────────────────────────────────────────────────
    match /sos_events/{eventId} {
      allow read: if isOwner(resource.data.travelerId) ||
        hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow delete: if false;
    }

    // ── Disputes ──────────────────────────────────────────────────────
    match /disputes/{disputeId} {
      allow read: if isOwner(resource.data.filedBy) ||
        hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isOwner(
          get(/databases/$(database)/documents/disputes/$(disputeId)).data.filedBy
        ) || isAdmin();
        allow create: if isOwner(
          get(/databases/$(database)/documents/disputes/$(disputeId)).data.filedBy
        ) || isAdmin();
      }
    }

    // ── Audit Logs (append-only for admins) ────────────────────────────
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }
  }
}
