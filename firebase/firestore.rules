rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ── Helper Functions ──────────────────────────────────────────────
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isCampaignOwner(campaignId) {
      return isAuthenticated() &&
        get(/databases/$(database)/documents/campaigns/$(campaignId)).data.ownerId == request.auth.uid;
    }

    function isCampaignStaff(campaignId) {
      return isAuthenticated() &&
        exists(/databases/$(database)/documents/campaigns/$(campaignId)/staff/$(request.auth.uid));
    }

    function hasCampaignAccess(campaignId) {
      return isCampaignOwner(campaignId) || isCampaignStaff(campaignId) || isAdmin();
    }

    // ── Users ─────────────────────────────────────────────────────────
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ── Campaigns ─────────────────────────────────────────────────────
    match /campaigns/{campaignId} {
      // Public fields readable by all authenticated users (for storefront)
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isCampaignOwner(campaignId) || isAdmin();
      allow delete: if isAdmin();

      // Campaign Staff subcollection
      match /staff/{staffId} {
        allow read: if hasCampaignAccess(campaignId);
        allow write: if isCampaignOwner(campaignId) || isAdmin();
      }
    }

    // ── Trips ─────────────────────────────────────────────────────────
    match /trips/{tripId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        hasCampaignAccess(request.resource.data.campaignId);
      allow update: if hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow delete: if isAdmin();

      // Itinerary blocks
      match /itinerary_blocks/{blockId} {
        allow read: if isAuthenticated();
        allow write: if hasCampaignAccess(
          get(/databases/$(database)/documents/trips/$(tripId)).data.campaignId
        ) || isAdmin();
      }

      // Inventory
      match /inventory/{itemId} {
        allow read: if isAuthenticated();
        allow write: if hasCampaignAccess(
          get(/databases/$(database)/documents/trips/$(tripId)).data.campaignId
        ) || isAdmin();
      }

      // Pricing tiers
      match /pricing_tiers/{tierId} {
        allow read: if isAuthenticated();
        allow write: if hasCampaignAccess(
          get(/databases/$(database)/documents/trips/$(tripId)).data.campaignId
        ) || isAdmin();
      }
    }

    // ── Bookings ──────────────────────────────────────────────────────
    match /bookings/{bookingId} {
      allow read: if isOwner(resource.data.userId) ||
        hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow update: if isOwner(resource.data.userId) ||
        hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow delete: if isAdmin();

      // Passengers subcollection
      match /passengers/{passengerId} {
        allow read: if isOwner(
          get(/databases/$(database)/documents/bookings/$(bookingId)).data.userId
        ) || hasCampaignAccess(
          get(/databases/$(database)/documents/bookings/$(bookingId)).data.campaignId
        ) || isAdmin();
        allow write: if isOwner(
          get(/databases/$(database)/documents/bookings/$(bookingId)).data.userId
        ) || hasCampaignAccess(
          get(/databases/$(database)/documents/bookings/$(bookingId)).data.campaignId
        ) || isAdmin();
      }
    }

    // ── Payments (server-write only) ──────────────────────────────────
    match /payments/{paymentId} {
      allow read: if isOwner(resource.data.userId) ||
        hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow write: if false; // Server-side only via Admin SDK
    }

    // ── Payouts (admin-managed) ───────────────────────────────────────
    match /payouts/{payoutId} {
      allow read: if hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow write: if isAdmin();
    }

    // ── Notifications ─────────────────────────────────────────────────
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId) || isAdmin();
      allow create: if hasCampaignAccess(request.resource.data.campaignId) || isAdmin();
      allow update: if isOwner(resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ── SOS Events ────────────────────────────────────────────────────
    match /sos_events/{eventId} {
      allow read: if isOwner(resource.data.userId) ||
        hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow delete: if false;
    }

    // ── Disputes ──────────────────────────────────────────────────────
    match /disputes/{disputeId} {
      allow read: if isOwner(resource.data.userId) ||
        hasCampaignAccess(resource.data.campaignId) || isAdmin();
      allow create: if isAuthenticated();
      allow update: if isAdmin();
      allow delete: if false;

      match /messages/{messageId} {
        allow read: if isOwner(
          get(/databases/$(database)/documents/disputes/$(disputeId)).data.userId
        ) || isAdmin();
        allow create: if isOwner(
          get(/databases/$(database)/documents/disputes/$(disputeId)).data.userId
        ) || isAdmin();
      }
    }

    // ── Audit Logs (immutable) ────────────────────────────────────────
    match /audit_logs/{logId} {
      allow read: if isAdmin();
      allow write: if false; // Server-side only
    }
  }
}
